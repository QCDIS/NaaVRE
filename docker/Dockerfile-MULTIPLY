#FROM qcdis/miniconda3-multiply as build

#FROM jupyterhub/k8s-singleuser-sample:1.1.3-n248.h20c9028e AS runtime
FROM jupyterhub/k8s-singleuser-sample:1.1.3-n248.h20c9028e
USER root

#===== Add pdalpy dependencies ======
RUN apt-get update --allow-releaseinfo-change && apt-get -y install gcc g++
#====================================


ADD start-jupyter.sh /usr/local/bin/start-jupyter.sh
ADD jupyterlab_vre-0.1.0-py3-none-any.whl /home/jovyan/jupyterlab_vre-0.1.0-py3-none-any.whl
COPY ./notebooks/ /home/jovyan/notebooks/

RUN chmod ugo+x /usr/local/bin/start-jupyter.sh

USER $NB_USER

RUN conda remove --force -y terminado && \
    python -m pip install --upgrade pip

RUN python3 -m pip install --quiet --no-cache-dir /home/jovyan/jupyterlab_vre-0.1.0-py3-none-any.whl && \
    jupyter serverextension enable --py jupyterlab_vre --user && \
    jupyter lab build --debug;

RUN python3 -m pip install --quiet --no-cache-dir https://github.com/QCDIS/Deploy_MULTIPLY/releases/download/0.1/multiply_core-0.6.1.dev0-py3-none-any.whl \
    https://github.com/QCDIS/Deploy_MULTIPLY/releases/download/0.1/multiply_data_access-0.5.2-py3-none-any.whl \
    https://github.com/QCDIS/Deploy_MULTIPLY/releases/download/0.1/multiply_inference_engine-0.6.1.dev0-py3-none-any.whl \
    https://github.com/QCDIS/Deploy_MULTIPLY/releases/download/0.1/multiply_sar_pre_processing-0.1-py3-none-any.whl \
    scipy shapely \

RUN conda install --yes -c conda-forge pdal python-pdal gdal && \
    conda upgrade --yes numpy && \
    conda update --yes -n base conda && \
    pip install dask distributed lazperf==1.4.4 && \
    pip install laserfarm

CMD ["/usr/local/bin/start-jupyter.sh"]