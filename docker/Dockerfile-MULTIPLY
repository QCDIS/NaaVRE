FROM continuumio/miniconda3 AS build
RUN apt-get update --allow-releaseinfo-change && apt-get -y install gcc g++
RUN conda install -c conda-forge conda-pack

RUN git clone https://github.com/JorisTimmermans/Deploy_MULTIPLY.git
WORKDIR Deploy_MULTIPLY
RUN conda env create -f environments/environment_multiply_platform.yml
RUN conda-pack -n multiply-platform -o /tmp/env.tar && \
    mkdir /venv && cd /venv && tar xf /tmp/env.tar && \
    rm /tmp/env.tar
RUN /venv/bin/conda-unpack


FROM jupyterhub/k8s-singleuser-sample:1.1.3-n248.h20c9028e AS runtime
COPY --from=build /venv /venv

USER root

RUN apt-get update --allow-releaseinfo-change && apt-get -y install git unzip gcc g++

ADD start-jupyter.sh /usr/local/bin/start-jupyter.sh
ADD jupyterlab_vre-0.1.0-py3-none-any.whl /home/jovyan/jupyterlab_vre-0.1.0-py3-none-any.whl
COPY ./notebooks/ /home/jovyan/notebooks/

RUN chmod ugo+x /usr/local/bin/start-jupyter.sh

COPY install_MULTIPLY.sh  /home/jovyan/install_MULTIPLY.sh
RUN chmod ugo+x install_MULTIPLY.sh

USER $NB_USER

#RUN source /venv/bin/activate
RUN /home/jovyan/install_MULTIPLY.sh

RUN conda remove --force -y terminado && \
    python -m pip install --upgrade pip

RUN python3 -m pip install --quiet --no-cache-dir /home/jovyan/jupyterlab_vre-0.1.0-py3-none-any.whl && \
    jupyter serverextension enable --py jupyterlab_vre --user && \
    jupyter lab build --debug;

CMD ["/usr/local/bin/start-jupyter.sh"]