FROM jupyterhub/k8s-singleuser-sample:1.1.3-n248.h20c9028e

USER root

RUN apt-get update --allow-releaseinfo-change && apt-get -y install git unzip

ADD start-jupyter.sh /usr/local/bin/start-jupyter.sh
ADD jupyterlab_vre-0.1.0-py3-none-any.whl /home/jovyan/jupyterlab_vre-0.1.0-py3-none-any.whl
COPY ./notebooks/ /home/jovyan/notebooks/

RUN chmod ugo+x /usr/local/bin/start-jupyter.sh

USER $NB_USER

RUN conda remove --force -y terminado && \
    python -m pip install --upgrade pip

RUN python3 -m pip install --quiet --no-cache-dir /home/jovyan/jupyterlab_vre-0.1.0-py3-none-any.whl && \
    jupyter serverextension enable --py jupyterlab_vre --user && \
    jupyter lab build --debug;


#===== Add MULTIPLY dependencies ======

#========= Install_environments =======
#RUN git clone https://github.com/JorisTimmermans/Deploy_MULTIPLY.git
#WORKDIR Deploy_MULTIPLY
COPY MULTIPLY_conda_requirements.txt .
COPY MULTIPLY_pip_requirements.txt .
RUN conda update --all
RUN conda install --no-pin --channel conda-forge --channel defaults --file MULTIPLY_conda_requirements.txt
RUN pip install -r MULTIPLY_pip_requirements.txt
#====================================
#========= multiply_modules =======
RUN git clone https://github.com/JorisTimmermans/atmospheric_correction.git
WORKDIR atmospheric_correction
RUN python setup.py develop
WORKDIR ../
RUN rm -r atmospheric_correction
#====================================



CMD ["/usr/local/bin/start-jupyter.sh"]